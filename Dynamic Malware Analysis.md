### What will you have learned at the end of the training?

Especially, Tier 1 level SOC analysts frequently make use of dynamic malware analysis method in their daily work routine. “Introduction to Dynamic Malware Analysis” training has been created in order to have the necessary foundations about this method.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-16.png)

Following topics will be taught throughout the training;

- What the dynamic malware analysis is,
- Tools and software that are needed to be able to analyze,
- Creating a Virtual Machine for dynamic malware analysis,
- What to consider in dynamic malware analysis,
- How to bypass some anti-malware analysis methods,

At the end of the training, you can turn your technical knowledge into practice by working with the real malware samples used in cyber attacks. You can also evaluate yourself and measure your level of knowledge with the Quiz.

---

### What is Dynamic Malware Analysis?

Dynamic malware analysis method is an analysis method in which malware is run and examined in secure environments. In this method, it is aimed to analyze the behavior of the malicious software by examining the activities like network, and file, etc. in secure environments.

It is a method that is widely preferred by the SOC analysts in the first place as you can perform faster analysis than the static analysis method. You can find our blog post about Static Analysis and Dynamic Analysis methods [here](https://letsdefend.io/blog/which-approach-should-you-choose-when-analyzing-malware/).

Various sandbox solutions are available to automate the dynamic analysis. Sandboxes run the malware in their own isolated environments and automatically present the analysis results. These sandbox solutions are crucial for the SOC analysts.
## **Advantages of the Dynamic Analysis Method**

Some of the advantages of the dynamic analysis method are;

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-20.png)

- It produces much faster results than the static analysis method,
- You can perform automated analysis with sandboxes,
- It is an analysis method that requires less technical knowledge than static analysis, so beginners can learn easily.
## **Disadvantages of the Dynamic Analysis Method**

Some of the disadvantages of the dynamic analysis method are;

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-21.png)

- You cannot determine the full malware capacity, as the behavior of the malware may vary from different systems.
- You cannot usually analyze advanced malware with the dynamic analysis method alone, in these cases you may need to use both dynamic and static analysis methods together.

---

### Importance of Dynamic Malware Analysis for SOC Analysts

If you ask a friend of yours who works as a SOC analyst about what they do at work, one of the things you may probably hear will be that "I am analyzing suspicious files". Malware analysis is one of the most important tasks of SOC. I can easily say that you will work closely with malware in your daily life, no matter what level of SOC analyst you are.

So why dynamic analysis and not static analysis?

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-4.jpeg)

Both analysis methods have their own advantages and disadvantages. In fact, these two methods do not substitute each other. When you want to analyze a malware, you need to combine these two methods and analyze it. Malware analysis is divided into two as an analysis method, and in this tutorial, we will focus on Dynamic Analysis.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-19.png)

As a SOC analyst, you are racing against time. The faster you can detect a harmful situation, the faster you can take action against it. SOC analysts first prefer the dynamic analysis method since it can produce much faster results than the static analysis.

Dynamic analysis method, which can be summarized as "run the malware and examine its activities", may seem simple, but it is a very difficult and dangerous analysis method for a person who does not know what he is doing.

---

### Which tools and software do we need?

We will need some software when applying the dynamic analysis method. Let's take a look at these software categories.
## **Virtualization Software**

We do not want to conduct dynamic analysis on our own system as we need to run the malware to be able to examine its activities. For this reason, we should make use of Virtualization Software that helps us work on some virtual systems.

Thanks to these software, you can use a different operating system on your host operating system. If they are configured properly, you can perform your analysis safely, as malicious software cannot escape from this virtual operating system. It is useful to make a small note here on these virtualization software. Since these virtualization environments are essentially software, various vulnerabilities that allow malwares to escape out of these virtual environments and allow code executions on the host operating system may occur on these environments. For this reason, It is crucial to keep your virtualization software up-to-date.

Some of the frequently used virtualization software are as follows;

- VMware Workstation
- VMware Fusion
- Oracle Virtualbox

An ideal isolated dynamic analysis environment consists of a completely separate physical device and a separate network. However, setting up this complex environment is both very costly and it is not necessary to begin with.
## **Utility Softwares**

After installing your own virtual operating system, you need to install software that will be useful in dynamic analysis. For example, we will not be able to perform dynamic analysis of office files with file extensions such as docx, xlsx without installing Microsoft Office or similar software on the system.

1. Microsoft Office
2. Adobe Reader
3. Browser (Chrome, Firefox etc.)
4. WinRAR
5. Text Editors (Notepad++, Sublime Text etc.)

The attackers are very familiar with the dynamic analysis method. Therefore they check whether frequently used software is installed or not on the target system to be able determine if the malware is running on a virtual operating system before performing malicious activities on the devices they compromised.
## **Debuggers**

Debuggers are software that are generally used by programmers to test the codes and catch the errors. Debuggers help to see the instructions of a process and change the flow of the program

Malware analysts frequently make use of debuggers to learn the working structure of the malware and disable some prevention mechanisms by making changes to the malware codes.

For instance, you want to analyze a malware that does not work when the device name is not “John”. With the help of the Debugger, you can disable this control by making changes to the codes in which this control is made, and ensure that the malware continues to run.

Since this training addresses the beginner topics, we will not go in detail about debugging, but since we will use them in our future training, installing debuggers now will make our work easier.

Some debuggers that are frequently preferred by malware analysts are as follows.

- Ollydbg
- X64dbg
- Windbg
- Radare2
## **Network Monitoring Tools**

Information such as the network connections established by the malware, the addresses it communicates with and how it communicates with those should be reported as a result of the malware analysis.

We need some software to detect the network activities of the malware. Some of them are as follows.

- Wireshark
- Fiddler
- Burp Suite
## **Process Monitoring Tools**
 
A new process is created for the program we run for malware analysis. In order to monitor these processes, we should use process monitoring tools.

Windows already comes with a process monitoring tool called “Task Manager”. However, other process monitoring tools are more useful in terms of usage and features for malware analysis.

You can install the following process monitoring tools in the virtual operating system we will create for dynamic malware analysis.

- Process Hacker
- Process Explorer (SysInternals)
- Procmon (SysInternals)
## **File Activity Monitoring Tools**

File activities are one of the first activities that should be followed in dynamic analysis. Malware can read files to collect information from the operating system, write other components of the malware to the file system, and move itself to the startup folder to ensure the persistence. Malware can be involved in various activities in the file system for these and other reasons. We should detect and indicate these activities in the malware analysis report.

You can use the following tools to see file activities.

- Sysmon
## **Other Tools**

- SysInternal Tools
- CFF Explorer
- PEView
- TriDNet
- BinText
- PEiD
- Regshot
- HashMyFiles
### Questions Progress

Which of the following tools is different from the others in terms of its function?  
  
- Ollydbg  
- Procmon  
- Radare  
- IDA  

What activities cannot be viewed with Procmon?  
  
- Network  
- File  
- Registry  
- Process  
- Syscalls  

Which of the following tools does not provide hash information of files?  
  
- Powershell  
- Certutil  
- Procmon  
- HashMyFile  

---

### Creating Virtual Machine

## **Installing Virtualization Software**

Before installing a virtual operating system, we need to install one of the virtualization software that enables this.

While there are some differences between them, any of the virtualization software will help us for our dynamic analysis. You can install one of the following virtualization software:

- VMware Workstation
- VMware Fusion (for macOS)
- Oracle Virtualbox

We will use VMware Workstation virtualization software during the training and it is recommended for you to install it so that you can follow the training easily.

You can download and install VMware Workstation [here](https://www.vmware.com/products/workstation-player.html).
## **Installing Operating System**

After installing the virtualization software on our system, let's set up our operating system with the help of these virtualization software.

In order to install the operating system together with the virtualization software, we need to obtain the ISO files of the operating systems. You can use the application called [MediaCreationTool](https://www.microsoft.com/en-us/software-download/windows10) published by Microsoft to create an ISO file for the Windows operating system.

Malware may be programmed not to work or to behave differently depending on the operating system. For this reason, we strongly recommend that you have different operating systems at hand.

When you run MediaCreationTool, you will be prompted with “Upgrade this PC now” and “Create installation media” options. Let's continue by selecting the "Create installation media" option.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-22.png)

Then we are asked to choose Language, operating system version information and operating system architecture. From here you can choose the Windows 10 64bit option. We recommend you to choose the operating system with 64bit architecture first. You can run both 32-bit applications and 64-bit applications on operating systems with 64-bit architecture, but you can only run 32-bit applications on operating systems with 32-bit architecture.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-23.png)

After choosing the operating system version information and architecture, we are asked whether we want to write to the USB drive or create an ISO file. Since we need the ISO file, we choose the ISO option here.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-24.png)

Then we are asked in which directory we want the ISO file to be saved. You may choose an appropriate directory for you.

When you complete these steps, the ISO file will be saved in the directory you specified. (This step may take a long time.)

Now that we have the ISO file, we can proceed to the installation of the operating system. Since VMware Workstation will be used in this training series, the lecture will be through this software. However, If you wish to use another virtualization software you should be able to adapt the lecture for other virtualization software easily since all these software are very similar.

Since we are going to install a new operating system, we must first click on the "Create a New Virtual Machine" button. Alternatively, you can select “File” from the top menu and then “New Virtual Machine”.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-25.png)

Then, we are asked to choose what kind of installation we want to proceed with. We continue our installation by choosing “Typical (recommended)”.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-26.png)

We select the ISO file that we have downloaded by selecting the “Installer disc image file (iso)” option.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-27.png)

Next, we are asked to name the Virtual Machine and specify the directory that we want the files of the VM to be kept. You can use "Windows10 Dynamic Analysis" as the name and “the default directory” as the directory. We recommend giving it a descriptive name to your VM so that you won’t confuse your VMs if you have multiple. If you wish you can change this name you have given to the VM later.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-28.png)

After choosing the name and the directory where the VM's files will be kept, we are asked to determine the disk size of our operating system. Since we will install various software and applications in it, we recommend that you allocate a minimum of 60-70 GB.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-29.png)

Finally, we are presented with some hardware settings that the operating system uses. At this stage, we go to the customization step by clicking the "Customize Hardware" button.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-30.png)

Since we are using an operating system with a 64-bit architecture, I recommend reserving a minimum of 4 GB of RAM. If you assign lower settings you may end up with performance and operating system errors. However, if you are installing an operating system with a 32-bit architecture, then you may allocate less RAM.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-31.png)

After we pass this stage, a Virtual Machine with the settings we specified is being created.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-32.png)

After the VM is created, you can install the operating system normally by running the created VM.
## **Installing Tools and Softwares**

At this point, our operating system is now ready for use. Next is the installation of tools and software that we will use during dynamic analysis.

You should install the tools we mentioned in our previous article on your virtual operating system now. You can easily install these tools by following the setup wizard.
## **Tweaking Virtual Machine**

We need to make some configuration changes on our Virtual Machine to be able to use it for malware analysis.

1. **Turn off anti-malware solutions**

Since we will analyze malware on our VM, we do not want antivirus software to delete the malware we have installed for analysis. We should turn off Windows Defender which comes active by default in Windows operating systems.

You should go to Windows Defender settings and disable all active settings. The feature that instantly scans and deletes the malware you have installed to analyze is “**Real-time protection**”. Make sure you turn this feature off.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-33.png)

**Disable Windows Defender Using Group Policy**

You can open the Local Group Policy Editor application by searching for “edit group policy” in the start menu. Alternatively, you can access the Local Group Policy Editor application by searching for “gpedit.msc” or by running it through “Search>Run” function on Windows.

To disable Windows Defender using the Local Group Policy Editor application, you must access the policy below.

“Computer Configuration > Administrative Templates > Windows Components > Microsoft Defender Antivirus”

Here, you should double-click the "Turn off Microsoft Defender Antivirus" policy and set it to "Enabled".

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-34.png)

You should also disable the "Monitor file and program activity on your computer" policy under "Real-time Protection".

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-35.png)

2. **Rename your virtual operating system**

Some malicious software makes various checks in order not to work in analysis environments. One of these checks is to check the hostname. Since most sandboxes have hostnames such as "Sandbox", "Malware", "Cuckoo" …, malware is programmed not to run on systems with these hostnames.

You should make your VM look like a normal user's system as much as possible so that you can avoid anti-analysis techniques. Specifying a random name as the hostname will allow you to help avoid such checks.

To change the device name, you must select “Settings → System → About” and then click the “Rename this PC” button.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-36.png)

Don’t forget to change your username too!

3. **Turn off auto updates**

The malware we are going to analyze may be taking advantage of vulnerabilities in the operating system. In order for the malware to run as normally as possible, we need to turn off the automatic updates of our virtual operating system.

You can turn off automatic updates through the group policy settings.

You can open the Local Group Policy Editor application by searching for “edit group policy” in the start menu. Alternatively, you can access the Local Group Policy Editor application by searching for “gpedit.msc” or by running it through the “Search>Run” function on Windows.

You should then access the policy below.

“Computer Configuration > Administrative Templates > Windows Components > Windows Update”

After accessing the relevant policy, you should set the policy named "Configure Automatic Updates" to "Disabled".

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-37-1024x435.png)

4. **Disable Hidden Extensions**

You may have seen the attackers try to trick their victims by changing the file extensions. How could they do this?

Windows operating systems are set to hide known file extensions by default. In other words, a file named "Chrome.exe" will appear as "Chrome" by default. Attackers name their malicious software as "Photo.jpg.exe", causing the user to see the file as "Photo.jpg". When the user thinks that this file is an image file and opens it, the malware will start to run.

In order not to get confused with this during our analysis, we need to fix it so that the extensions that are hidden by default are always shown.

For this, we need to open the application named “File Explorer” and access the settings menu by clicking the “File” and then “Change folder and search options” buttons from the top menu.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-38.png)

Then you should save the settings by unchecking “Hide extensions for known file types” from the “View” tab.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-39.png)

5. **Show Hidden Files and Folders**

Malware aims to prevent the user from detecting their files by hiding them. By default, showing hidden files and directories will enable us to perform a more comfortable analysis.

Let's open the application called File Explorer and open the settings menu with the help of "File" from the top menu, then click "Change folder and search options".

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-40.png)

Then, let's check the "Show hidden files, folders, and drives" from the "View" tab and save the setting.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-41.png)

6. **Disable ASLR**

New versions of Windows have an anti-exploit security mechanism called ASLR (Address Space Layout Randomization). We won't get into ASLR too much in this training, but you may want to disable this feature at this stage as it will come up in the future.

You can disable this setting with the help of Registry. Access the following registry by opening the Registry Editor application.

“HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management”

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-42.png)

Then create a “REG_DWORD” type key named “MoveImages”.

These settings will eventually disable the ASLR feature.

7. **Disable Windows Firewall**

As we implemented in the previous steps, we should disable the Windows Firewall to prevent the security mechanisms from interfering with the malicious software we analyze.

Access Windows Defender Firewall settings via the control panel. You can access these settings using the search bar in the top menu of File Explorer. If you copy and search the following path in this search bar, it will take you to the Windows Defender Firewall settings.

“Control Panel\System and Security\Windows Defender Firewall\Customize Settings”

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-43.png)

After accessing the Defender Firewall settings, select "Turn off Windows Defender Firewall" and save it. This will disable the Firewall.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-44.png)

8. **Mimic an End-User System**

You should make your VM look like a normal end-user operating system as much as possible so that the malware you are analyzing is not caught by anti-analysis techniques.

Since there are no precise instructions or settings for this, it's totally up to you to make your analysis VM look like a normal end-user's computer. We can recommend the following tips to implement on your VM to establish this similarity:

- Installing browsers frequently preferred by end-users such as Chrome and Firefox,
- Leaving files in different directories that will be of interest to the attacker,
- Changing the desktop background,
- To ensure that some files are found in the Downloads directory by downloading small applications through the browser

9. **Change Network Settings**

We need to prevent our malware from spreading to different devices via network connection. Thanks to the private networks provided by virtualization software, we can prevent malware from infecting different devices.

For this, you must click on the "VM" menu in the top menu of VMware Workstation and select "Settings".

You should select the "Custom" setting by selecting "Network Adapter" from the left menu in the window that opens.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-45.png)
## **Take a Snapshot**

Your operating system may be affected functionally or become unusable after you analyze malware or ransomware on your system. When you want to analyze a new malware after running and analyzing another malware, you do not want your operating system to get affected by the changes that was made by the old malware you analyzed.

In such cases, you can take advantage of the Snapshot feature of virtualization software.

Snapshot is a feature that allows you to take a snapshot of your Virtual Machine and return to this backup later.

Our VM has been configured for malware analysis and the applications that we will be using in the analysis have been installed into it. At this stage, you can take a Snapshot and then switch to the same analysis environment with your clean VM.

To take snapshots, you can access the screen where you manage Snapshots by clicking the "VM" menu in the top menu of the VMware Workstation application and clicking "Snapshot" -> "Snapshot Manager".

Then you can take a snapshot of your VM by clicking the "Take Snapshot" button. That's how easy it is to take snapshots.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-46.png)

Entering detailed information on the description will allow you to easily find the Snapshot you need. For this reason, we recommend that you enter as descriptive comments as possible.
### Questions Progress

What is the Network configuration that provides Internet access through the network interface of the host operating system?  
  
- NAT  
- Bridge  
- Host-Only  
- Private  

What name should a registry key be created to disable the ASLR feature?

---

### What Should We Pay Attention to when we conduct a Dynamic Analysis?

We mentioned that the dynamic analysis is the method that we actually run the malware on our own system and analyze its activities on the operating system.

So what should we do after running the malware? Are we going to run it and just watch the screen?

In this article, we will talk about the steps you should follow after running the malware.
## **Process Activities**

When the malware is run, it creates a process of its own like other applications. All operations on the operating system are carried out through a process. Before following other activities, we must detect the processes belonging to the malware.

A large number of process, network, registry and file activities take place within the operating system. Since it may not be possible to analyze all these activities, we can start analyzing the activities of the malware processes to see if we can find anything solid about its activities.

When examining a process, special attention should be paid to information such as whether it creates a new child process, the DLLs it imports, and which user it is run by.

You can use an application called Process Hacker to examine processes.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-47.png)

Process Hacker makes it easy to examine processes by listing processes in a hierarchical view. When the malware creates a new process, you can see the newly created process under its parent process.

Malware can inject itself into different processes, perform activities for its own purposes with living of the land binaries, or make legitimate applications run their own applications. For these reasons, the activities of all processes belonging to the malware and used by the malware should be analyzed.

For instance, let’s say the malware injects itself into the notepad.exe process after it runs. In this case, we need to examine all of the activities that notepad.exe has created since the moment it was injected.

Topics like Process Injection will be discussed in the malware analysis trainings.
## **Network Activities**

Malware often establish a network connection to download the second payload, to communicate with command and control (c2), to jump to other devices in the network, to steal data.

At the end of our malware analysis we need to detect these network connections, learn how the malware communicates, and report these network activities.

Wireshark is a software that can meet all your needs for analyzing network activities. However, you may choose tools such as Fiddler, in cases where you know that the malware communicates especially over the HTTP protocol (Malware mostly communicates via protocols such as HTTP, SMTP).
## **Registry Activities**

We mentioned Registries in the Windows tutorial. Quickly again, registries are hierarchical databases that are used for data storage in Windows operating systems. It is used by attackers for purposes such as stealing data and ensuring persistence.

Windows keeps applications to run when the operating system is started in some registry keys. Attackers aim to ensure persistence by taking the advantage of this feature of the operating system, and adding their own malicious software to these registry keys.

Some of these registry keys;

- HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
- HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
- HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
- HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce

Since Registries are also used a lot by normal processes, you, specifically need to look at the registry changes made by malicious software processes.

By using the application called Regshot, you can detect the changes that the malware has made on the Registries.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-48.png)

Before executing the malware, you can run Regshot and click the "1st shot" button to let Regshot collect existing registries.

Then, you should press the "2nd shot" button to get a new shot after running the malware and allowing some time to show activity. You can see the differences between these two shots of Regshot by pressing the “Compare” button.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-49-1024x517.png)
## **File Activities**

Malware performs file activities on the operating system for many reasons. Recently, attackers have developed fileless malware to prevent detection.

On Windows, there is a directory called "Temp" where temporary files are located. Applications usually use this directory to host their volatile files. Malware often copies itself to the Temp directory. For this reason, you should pay special attention to the activities performed on this directory.

You can access this directory by pressing the “**Win ​​+ R**” key combination and typing the following command afterwards:

- **%TEMP%**

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-50.png)

In order to ensure persistence, malware also copies itself to the Startup directory, which contains applications that will run automatically when the operating system starts. You should pay special attention to the activities performed in these directories.

You can access this directory by pressing the “**Win ​​+ R**” key combination and typing the following command afterwards:

- **shell:startup**
- **shell:common startup**

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-51.png)

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-52.png)

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-53.png)

### Questions Progress

Which tool should be used to detect network activities?  
  
- Regshot  
- HashMyFiles  
- Fiddler  
- Process Hacker  

What command should be typed in the "Run" application to switch to the “temp folder”.

---

### Dynamic Malware Analysis Example #1

**File Name:** e-Archive Dekont.exe

**MD5 Hash:** 7a0093c743fc33a5e111f2fec269f79b

**SHA256 Hash:** 722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088
## **Preparing**

Because our monitoring tools list all the activities that have been done since the time the malware was run, we should run these tools before executing the suspicious program we have. Otherwise, we will not be able to see malicious activities on these tools even though they carry out malicious software activities.

Let's run our tool called 'Process Hacker' to see the process activities. Because we will run the malware by clicking on the desktop, we will see the process belonging to the malware under the explorer.exe process, so we need to pay special attention to it.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-54.png)

To see the file activities, run the tool called “Procmon” in the SysInternals toolkit. This tool allows us to see process, file, registry and network activities. However, since there are so many logs, it can be difficult to read and conclude meaningful results. (Yes, even if you don't see it, your OS really works that much in the background!)

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-55.png)

Run RegShot to see registry activities. Take a shot by pressing the “1st shot” button before running the malware. This process will take some time.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-56.png)

You can use Wireshark and Fiddler to see network activities. Fiddler will suffice, as the malware we reviewed communicates over the HTTP protocol.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-57.png)
## **Analyze**

Now that we have completed the necessary preparations before running the malware, you can run the malware on your VM.

For a better understanding, we will examine the process, network, registry and file activities separately. After reviewing these activities, we will create a timeline.

After allowing enough time for the malware to perform its activity, let's take the second shot by pressing the "2nd shot" button from the Regshot tool.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-58.png)

### **Process Activities**

As we mentioned earlier in our training series, there are some advantages of detecting process activities first. Since we will encounter a lot of logs and activities, the first step we need to do is to detect the processes belonging to the malware.

When we examine the processes occurred over Process Hacker, we see that only one process belonging to the malware is running.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-59.png)

However, things are not always as they seem! Since Process Hacker only shows the processes that are running momentarily, the malware may have created a child process at a time we did not monitor and terminated it later.

At this point, the Procmon tool comes to our rescue. If you press the "Show Process Tree" button in the top menu, procmon will show the process tree it has created for you during the time it has recorded.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-60.png)

The process tree provided by Procmon completes this shortcoming of Process Hacker, as it also includes terminated processes.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-61.png)

When we go over the the image above, we see that the first process we run (9076 PID) runs the tool called “schtasks.exe” belonging to Windows Task Scheduler (PID 4800) and then runs its own malware (7944 PID) again.

Before moving on to other activities, let's examine the schtasks.exe process. Schtasks.exe is a tool that enables the Task Scheduler to be used via the command interface in the Windows operating system. Attackers ensure persistency by adding their own malware to scheduled tasks with the help of Task Scheduler.

In order to see what kind of scheduled task the attacker added, we must click on the "schtasks.exe" (4800 PID) in the process tree of procmon and examine its details.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-62.png)

When we examine the command-line arguments, we see that a scheduled task named "Updates\VbxFiQYCyFDgGL" has been created. However, the information of the scheduled task except for its name is in the XML file located at the following path:

“C:\Users\Amanda\AppData\Local\Temp\tmpCCF2.tmp”.

Click [here](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks) to get information about the command-line arguments of the tool named Schtasks.exe.

When you try to access the relevant file, you can see that the file is deleted. But don't worry, this scheduled task is now saved so we can see it through the Scheduler Task.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-63.png)

On the Trigger tab, you can see in which situations this scheduled task added by the attacker will run. As it can be seen on the screenshot above this scheduled task will run at log on.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-64.png)

You can see what action will run on the Actions tab. You can see on the above screenshot that the malicious software named “VbxFiQYCyFDgGL.exe” prepared by the attacker will run when this scheduled task runs.

This is how we have detected the scheduled task that the attacker added.

We detected malware processes (9076, 4800, 7944 PIDs) with the help of Procmon. Next, we need to detect the network, file and registry activities of these processes.

You filter down the processes with PID values of 9076, 4800, 7944 on Procmon. However, there is an easier method. When you right-click on the top parent process of the malware and press the "Add process and children to Include filter" button, procmon will create these filters for you.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-65.png)
### **Network Activities**

Since the malware we examined communicates over the HTTP protocol, you can detect the connections it establishes very easily using the Fiddler tool.

After running the malware, you can see that the process named “e-archive dekont.exe” on Fiddler communicates with the domain “**5gw4d[.]xyz**”.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-66.png)
### **Registry Activities**

When we examine the registry activities, you can see that the keys under HKLM\Software\WOW6432Node\Microsoft\Windows\CurrrentVersion\Uninstall are queried. There are settings under this key that are left by the applications installed in the system for uninstall. It is often preferred to enumerate this key to detect applications installed on the system by attackers.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-67-1024x686.png)
### **File Activities**

To detect malware file activities, disable the other three activities in the top menu of procmon.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-68.png)

You can enter a filter with Operation=CreateFile to see file creation activities.

When we examine the logs, we see that an executable file named "VbxFiQYCyFDgGL.exe" is written under the "C:\Users\Amanda\AppData\Roaming\" directory.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-69-1024x291.png)

When we look at the hash of the application named “VbxFiQYCyFDgGL.exe” with the tool called HashMyFiles, we see that it is actually the same file as the file we analyzed first. We see that the malware has copied itself to a different folder.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-70.png)

When we examine the file activities further, we see that the malware reads the files to steal information from applications such as Firefox, Chome, Thunderbird. We have determined that the malware we have is information stealer.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-71-1024x388.png)
## **Result**

Now that we have completed the malware analysis, we can combine the information we have gathered. We have detected that:

- the malware has copied itself to the "C:\Users\Username\AppData\Roaming\" directory with the name "VbxFiQYCyFDgGL.exe",
- has used Task Scheduler to ensure persistence,
- has enabled its own malicious application to run at every logon by creating a scheduled task with the name "VbxFiQYCyFDgGL" 
- communicates with the command & control server,
- the command control address is “5gw4d[.]xyz/PL341/index.php” and it communicates over the HTTP protocol,
- discovers the applications installed in the system with the help of the key under the "HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall" registry key,
- steals sensitive data from applications such as Chrome, Firefox, Thunderbird.
### **Artifacts**

MD5: 7a0093c743fc33a5e111f2fec269f79b  
SHA256: 722ef401e5cbb067c5c33faa402774d3c75ef08e0c8cc4d7e66a9cfa53684088  
File Name: e-Archive Dekont.exe  
File Name: VbxFiQYCyFDgGL.exe  
Domain: 5gw4d[.]xyz  
URL: http[:]//5gw4d[.]xyz/PL341/index.php  
### Lab Environment
### Questions Progress

(Desktop/Malware Samples/law.exe) Connect Virtual Machine via 'Connect' Button. What is the domain name that the malware connects to for data hijacking?

(Desktop/Malware Samples/law.exe) Connect Virtual Machine via 'Connect' Button. On which port does the malware communicate over?

(Desktop/Malware Samples/law.exe) Connect Virtual Machine via 'Connect' Button. What is the name of the executable file that the malicious application writes to the AppData directory?

(Desktop/Malware Samples/law.exe) Connect Virtual Machine via 'Connect' Button. Which Registry Key does the malware use to ensure persistence?

---

### Dynamic Malware Analysis Example #2

**File Name:** Sales Order Sheet.pdf.exe

**MD5 Hash:** 411019bcb582ef6e3dab080d99925b4b

**SHA256 Hash:** f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934
## **Preparing**

Because our monitoring tools list all the activities that have been done since the time the malware was run, we should run these tools before executing the suspicious program we have. Otherwise, we will not be able to see malicious activities on these tools even though they carry out malicious software activities.

Let's run our tool called 'Process Hacker' to see the process activities. Because we will run the malware by clicking on the desktop, we will see the process belonging to the malware under the explorer.exe process, so we need to pay special attention to it.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-72.png)

To see the file activities, run the tool called “Procmon” in the SysInternals toolkit. This tool allows us to see process, file, registry and network activities. However, since there are so many logs, it can be difficult to read and conclude meaningful results. (Yes, even if you don't see it, your OS really works that much in the background!)

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-73.png)

Run RegShot to see registry activities. Take a shot by pressing the “1st shot” button before running the malware. This process will take some time.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-74.png)

Open the Wireshark application to see network activities.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-75-1024x379.png)
## **Analyze**

Now that we have completed the necessary preparations before running the malware, you can run the malware on your VM.

For a better understanding, we will examine the process, network, registry and file activities separately. After reviewing these activities, we will create a timeline.

After allowing enough time for the malware to perform its activity, let's take the second shot by pressing the "2nd shot" button from the Regshot tool.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-76.png)

### **Process Activities**

When we examine the running processes using Process Hacker, we see that only 1 process belonging to the malware is running.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-77.png)

Like in our previous example, the malware may have created a different process, but we may not be able to see it because it is not running instantly. Let's confirm this behavior using the procmon tool.

If you press the "Show Process Tree" button in the top menu, procmon will show the process tree it has created for you during the time it has recorded.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-78.png)

As we can see in the image above, we see that the first process we run (8780 PID) has a child process (7100 PID) named "regsvcs.exe".

Regsvcs.exe is a tool called .NET Service Installation Utility, which is installed by default in Windows operating systems by Microsoft.

Attackers often name applications that come by default in the operating system to avoid detection. We have to determine whether the malware we are examining is really the legitimate application that comes by default in Windows or it is how the attacker named his own software to prevent detection.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-79.png)

When we examine the path information of the process, we see that the actual directory where the RegSvcs.exe tool, which comes by default in the Windows operating system appears. But, we still need to do a hash check to verify this.

Let's get the hash of "C:\Windows\Microsoft.NET\Framework\v4.0.30319\RegSvcs.exe" with the help of the tool named HashMyFile.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-80.png)

When we search the hash on VirusTotal, we see the the information that states the relevant application has been published by Microsoft.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-81.png)

We have determined that the running application is indeed an application published by Microsoft. So does this mean the app is safe?

Attackers can inject malicious code into legitimate applications by using techniques such as Code Injection, Process Hollowing, Reflective DLL Injection that allow these applications to run the malicious codes. In addition, there are binaries that are called "living of the land binary" and that allow malicious activities to be carried out without injecting malicious code.

We can assume that our malware creates this process to perform a malicious activity since it’s created by malware. However, we must always support our assumptions with valid evidence. The next time when we examine network, registry activities, we will prove that this process is indeed used for malicious purposes.

We detected malware processes (8780, 7100 PIDs) with the help of Procmon. Next, we need to detect the network, file and registry activities of these processes.

You can filter down processes with PID values ​​of 8780, 7100 on Procmon. However, there is an easier method. When you right-click on the top parent process of the malware and press the "**Add process and children to Include filter**" button, procmon will create these filters for you.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-82.png)

### **Network Activities**

Before performing our analysis on Wireshark, let's check to see if the malware makes any web requests, as it can be examined more easily.

When we look at the Fiddler application, we see that there is a web request made by the malware (regsvcs.exe, 7100 PID).

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-83.png)

When we examine the web request, we see that the malware makes a request to checkip.dyndns.org in order to find the public IP address. Attackers often use IP address learning services to perform targeted attacks or learn the victim's IP address. This behavior may be considered commonplace for malware.

Did you notice the name of the process making the web request? "Regsvcs.exe" should not throw such a request in normal use.

When we examine the network activities over Wireshark, we see that there is SMTP traffic. SMTP is the protocol used for sending email. Since we didn’t send email, we can say that this is a very suspicious traffic.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-84.png)

You can clearly see all SMTP traffic by right-clicking on any SMTP packet and clicking “**Follow**” then “**TCP Stream**”.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-85.png)

If we examine the SMTP traffic, we find that the malware connects to skychine[.]com[.]my's mail server and sends email to graceunlimited153@gmail[.]com with "**Pc Name: admin | Snake Keylogger**".

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-86.png)

When we look at the content of the mail, we see that there are multiple attachments with names such as "Password.txt", "User.txt". In order to bring the contents to readable format, we have to base64 decoding.

![](https://letsdefend.io/blog/wp-content/uploads/2022/07/image-87.png)

As you can see from the subject title and email content, the malware we analyzed is actually Snake Keylogger.

When we look at the e-mail content, we can see that the malware sends the user name, password information of the web applications and the IP address of the device.

Attackers often send the information they have obtained to their own email addresses using SMTP servers that they have previously seized. In other words, the skychine[.]com[.]my domain name is actually an SMTP server that is not malicious but is hijacked by the attacker and used for malicious purposes. However, since the email sent was sent to the attacker's email address, the graceunlimited153@gmail.com address most likely belongs to the attacker.
## **Result**

Now that we have completed the malware analysis, we can combine the information we have gathered. We have detected that:

- It’s Snake Keylogger
- Steals credentials from browsers
- Checks IP address
- Exfiltrates data via SMTP
- Connects skyshine.com[.]my:25
### **Artifacts**

MD5: 411019bcb582ef6e3dab080d99925b4b  
SHA256: f381e338212079c3a03fbbb532cdec44b1d27db03e8cc4c47408ef038885d934  
File Name: Sales Order Sheet.pdf.exe  
Domain: checkip.dyndns.org  
Domain: skyshine[.]com[.]my  
### Lab Environment
### Questions Progress

(Desktop/Malware Samples/payment advice.exe)(Password:infected) Connect Virtual Machine via 'Connect' Button. What is the domain name of the web application that the malware is requesting to learn its IP address?

(Desktop/Malware Samples/payment advice.exe) What is the domain name that the malware connects to for data hijacking?

(Desktop/Malware Samples/payment advice.exe) What port does the malware communicate over?

(Desktop/Malware Samples/payment advice.exe) What is the username used by the malware to authenticate to the mail server it connects for data hijacking?

(Desktop/Malware Samples/payment advice.exe) What is the password that the malware uses to authenticate to the mail server it connects for data hijacking?

---

### My Malware Doesn’t Do Anything?

From time to time, when you run malicious software, you may see that it does not show any activity on the operating system. Let's take a look at what we should do in such a situation.
## **Wait a Little Longer**

Many sandbox products tag the file as harmless if there is no suspicious activity after a certain period of time (usually 3-5 minutes) after running the suspicious file in order to use the resources in the most optimal way. Attackers who want to take advantage of this situation, add sleep functions to the malicious software they have preduced, so that their malicious code starts to run after a certain period of time. Sandboxes label software that has no activity during this time as harmless, and so it mostly allows it to pass through security products, causing it to reach the end user.

If the software you are running is not showing any activity, there is a high probability that it is using this method as it is a very common method nowadays. For this reason, you may need to be patient for a few minutes to show activity.
## **Execute as Administrator**

Most malware has the ability to terminate itself without exhibiting any malicious activity when not run at high privileges. For this reason, you can try to run a non-active malware with an authorized user.
## **Change Language Settings**

Since the number of targeted attacks is increasing day by day, you may find that malicious software does not work outside of these targets.

The malware will not run unless you have an environment with features that the malware controls. Target-oriented malware usually performs controls such as operating system information, operating system language, location information of the system via IP address, timezone information. You may need to create an environment targeted by malware to ensure that it displays malicious activities.
## **Use Different Network**

We mentioned that attackers develop targeted malware. One of the methods of detecting that malicious software is running on the desired target systems is to use the geolocation information of the IP address.

For example, in order to run a malicious software that is targeting France only, the attackers check whether the device is located in France or not by querying the IP address of the infected device in IP-GeoLocation services. For this reason, when your malware does not work, you can enable the device to access to the Internet through different countries IP addresses with the help of VPN tools.

“Which country should I choose when faced with this kind of situation?”

There is no definitive answer for this question. You have the chance to learn the country information by analyzing the malware with the help of static analysis, but you can reach a faster solution by guessing the attacker's target before using this method.

For example, if a malware is transmitted via an e-mail, you can try the countries where the language of the e-mail is spoken. If the e-mail is written in Spanish, you can try countries such as Spain, Mexico, Colombia, etc.
## **Other Methods**

You will most likely see the malware start to show activity as the methods we mentioned so far are the most used. However, there are still other methods that you can try.

1. Try running the malware from a different directory.
2. Change the screen resolution.
3. Perform activities on the operating system while the malware is running. (Creating different processes, moving the mouse, writing, etc.)

