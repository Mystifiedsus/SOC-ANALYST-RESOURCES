### Introduction to Malware Analysis

As a SOC analyst, you will often analyze suspicious files in your daily work routine. With the Malware fundamentals training, the necessary basic information will be learned by introducing the subject of malware analysis.

In this training;

- Definition of malware,
- Malware types,
- Malware analysis approaches,
- How to analyze suspicious files simply

will be taught.

---

### How Malware Analysis Help SOC Analysts

Have you ever heard of Stuxnet before? The US and Israeli intelligence services created Stuxnet to disrupt Iran's nuclear work. This malware, which was first detected in 2010, still has a complex structure even today. Although it contains many zero-day vulnerabilities, it provides propagation with USB devices. This malware damaged Iran’s Natanz uranium enrichment plants and caused it to be closed permanently.

![](https://letsdefend.io/blog/wp-content/uploads/2022/04/How-Stuxnet-Worked.jpg)

As you can see in the Stuxnet example, even if you are not very close to technology in your life, the impact of malware on our lives is quite high.

What about the importance of malwares in SOC for a person who wants to be a security analyst?

When you examine the work routine of a standard Security Analyst, you will see that the analysts frequently encounter suspicious files or processes. Considering that malware is used in the vast majority of cyber attacks, you can understand that this information is not unusual.

As a Security Analyst, you should be able to analyze and figure out whether these files are harmful; and, if it is malicious, you should understand the purpose of this software and how it communicates with the command and control servers. It is an undeniable fact that malware analysis is an indispensable know-how for Security Analysts.

Many malware analysis methods and techniques are available to examine suspicious files. In this training series, you can analyze malware using the most appropriate technique for your needs.

### Questions Progress

How many zero-day vulnerabilities exist in Stuxnet? (Answer should be string)

Which company's industrial control systems is Stuxnet targeting?

---

### Malware Definition and Malware Types

The word Malware is a word derived from the words **MAL**icious soft**WARE**. It is the name given to software that endangers the security and integrity of systems by targeting a malicious purpose.

Today, cyber threat actors use malicious software to achieve various purposes such as ensuring persistence, damaging systems, demanding ransom. As SOC analyst, we need to analyze suspicious software and understand whether the software is really harmful.

Since there is no restriction, you can come across malicious software written in almost all programming languages. You don't need to know all programming languages ​​to start analyzing malware. However, we can say that being familiar with programming makes it easy to analyze malicious software (it is even mandatory in matters such as reverse engineering).

With each passing day, we see that cyber threat actors develop themselves and develop more complex malware. Attackers now use various methods to make analysis of their malicious software even more difficult. Since these methods are at an advanced level, they will not be explained in the "Malware Fundamentals" training, and a special training will be prepared for these methods.

In this process, we must constantly improve ourselves in order to be prepared for current threats.

As a SOC analyst, you will encounter many suspicious files in your daily work routine. These files may have come via email, or may have been detected by the antivirus software on the user device, or they may have been detected by the network security products while being transferred. I believe you got the point :)

As a result of the analysis, you will be able to find whether the file is harmful or not; and its purpose if it is harmful, the command and control servers and the type of the malware.
## **Malware Types**

Although the names of the command and control servers and the methods they use vary, the purposes of malicious software are within certain categories. In this way, you can inform the other person about what the malware is doing by simply telling the category of the malware.

For example, if you say that the software you are examining is a keylogger, everyone will know that this is a software that records and plays the keys pressed on the keyboard. You may provide this important initial information about the malware to your upper management to give the idea about it and the attacker's target then follow up with the detailed analysis report.

As we mentioned, malicious software are divided into types according to their functions/purposes/characters. After analyzing the malware, you will match it with one of the following types. Therefore, you should know what these types are.

Some types of malware and their descriptions are as follows.

- **Backdoor:** Leaving a backdoor on the device where the malware is installed, it allows the attacker to access the system through this backdoor. For example, by opening a network port connected to the shell, it enables the attacker to connect to the system through this port.
- **Adware:** It often comes with downloaded software, causing unwanted advertisements to be displayed on the device. While not all adware is harmful, some change the default search engine.
- **Ransomware:** It is a type of malware that has been on the world agenda for the last few years. It demands ransom from people by encrypting and exfiltrating all files on the device.
- **Virus:** It is one of the first types of malware seen in the wild. So we see that in daily life, it is often called a virus instead of the term malware. Viruses have a self-replicate feature. It provides persistence by infecting other files on the device.
- **Worm:** Since this type of malware spreads from infected devices to other devices, it is named worm. WannaCry, a worm malware exploiting MS17-010 vulnerability, caused panic around the world.
- **Rootkit:** It is a type of malware that disguises itself by providing access to a high level of authority on the device.
- **RAT (Remote Access Trojan):** It is a type of malware that provides full control over the device to the threat actor.
- **Banking malware:** A type of malware that targets banking applications and causes money to be stolen from the victim.
- **Keylogger:** A type of malware that logs pushed keys and sends this information to attacker.

A malware may contain more than one feature, so a malware can belong to more than one type. For example, WannaCry malware includes both worm and ransomware malware features.

### Questions Progress

What is the name of the first worm malware to spread on the internet?

What is the vulnerability code of the vulnerability used by Wannacry?

What is the name of the malware that was detected in December 2021, distributed through the Solarwinds Orion product and caused the hacking of many organizations such as FireEye?

---

### What Should a Malware Analyst Know

Malware analysis is a subject that may seem easy from the outside, but in essence, it requires expertise in many aspects. While malware analysis is a separate field in its own right, some Tier 3 SOC Analysts (Subject Matter Experts) focus their careers in malware analysis only. Although malware analysis is a separate field, it is often used by Security Analysts in their daily work routines.

In order to be able to analyze malicious software correctly and successfully, it is necessary to have the basics in many subjects. Let's take a look at these topics.
## **Operating System Fundamentals and Architecture**

Since malware runs on operating systems, malware analysts should have a solid understanding and knowledge of the operating systems.

![](https://letsdefend.io/blog/wp-content/uploads/2022/04/monolithic_os_kernel.gif)

https://www.technologyuk.net/computing/computer-software/operating-systems/images/monolithic_os_kernel.gif

Malware often takes advantage of the features offered by the operating system, increasing its privileges, making discovery and ensuring persistence. To give an example on Windows operating systems, malicious software uses the features of the operating system such as Task Scheduler, Services, Registry to ensure persistence.

In addition to the features of the operating system, API, Syscalls, Memory Architecture and lower level issues are also important for successful malware analysis. We will focus on these topics more on the "Static Malware Analysis" training.
## **Assembly Language & Programming**

If you ever developed software before, have you wondered what happens when you compile the programming languages you write? Or have you ever wondered how the processors run multiple programming languages when there are many programming languages.

Processors only understand 0s and 1s. All data, except 0 and 1 are meaningless to the processors. When you compile any program in languages ​​such as, C/C++, Python, Java, Ruby, Go etc. compilers translate the codes you write into 0s and 1s that the processor can understand. When you start a program, these 0s and 1s are sent to the processor over the memory to run.

The lowest level programming language you can see is Assembly if we do not consider 0s and 1s. Each instruction has a direct 0 and 1 counterpart. When you compile a program written in C, it is first translated to Assembly language and then to 0s and 1s.

Compiled malware can be easily converted into the Assembly language. However, converting from Assembly language to the next level is not very easy and accurate, so analyses are usually made through Assembly language. Software that translates machine codes into Assembly language is called "Disassembler".

In the static code analysis training, we will also focus on the basics of the "Assembly" Language.
## **Network Protocols and Fundamentals**

Malware often exhibits network activity in order to hijack information, connect to a command and control server, or download second payloads. Understanding these network traffics while analyzing malware is extremely important for us to understand the purpose of the malware.

For this reason, malware analysts should have basic network knowledge.
## **Cryptography**

![](https://letsdefend.io/blog/wp-content/uploads/2022/05/image.png)

Many technologies make use of cryptography to provide security. It is also used by attackers for purposes such as complicating, preventing detection and preventing access.

Popular ransomware uses cryptography nowadays to encrypt files and prevent access to files without paying a ransom.

We often encounter cryptography during malware analysis.

### Questions Progress

Which encryption type ransomwares uses?

What is the encryption type frequently used by ransomware-type malware?

What is the name of the software that compiles of the written codes?

According to Wikipedia, in what year did assembly first appear?

What is the name of the software that translates machine code into assembly language?

---

### Which Approach Should You Choose When Analyzing Malware?

If you work in the defensive field, analyzing malware becomes part of your job.

In this article, we will discuss with which approaches you can analyze malware and the advantages / disadvantages of these approaches to each other.

There are 2 different approaches to analyzing malware.

1. Static Analysis
2. Dynamic Analysis
## **What is Static Analysis?**

It is the approach of analyzing malicious software by reverse engineering methods without running them.

Generally, by decompile / disassemble the malware, each step that the malware will execute is analyzed, hence the behavior / capacity of the malware can be analyzed.

![debugger](https://letsdefend.io/blog/wp-content/uploads/2020/11/linux-1024x696.gif)

https://www.hex-rays.com/products/ida/news/6_0/

Your device will not be infected as you do not run malicious software in static analysis. (However, we do not recommend performing static analysis on your host device, it will be more proper to do your analysis in a virtual operating system.)

The information examined during the static analysis is as follows.

1. P.E. (Portable Executable) Headers
2. Imported DLL's
3. Exported DLL's
4. Strings in binary
5. CPU Instructions

You can obtain malware sample from **blue team training** platform [LetsDefend](https://letsdefend.io/)
## **What is Dynamic Analysis?**

It is the approach that examines the behavior of malicious software on the system by running it.

In dynamic analysis, applications that can examine registry, file, network and process events are installed in the system, and their behavior is examined by running malicious software.

While doing dynamic analysis, you should carefully examine the following events.

1. Network Connections
2. File Events
3. Process Events
4. Registry Events

![process monitor tool](https://letsdefend.io/blog/wp-content/uploads/2020/11/procmon-app.png)

## **Static Analysis vs Dynamic Analysis**

Which approach to use when analyzing malware depends on the current circumstances. In cases where you want to get fast results, you can choose dynamic analysis, but we cannot say that the analysis is complete without doing both static and dynamic analysis.

It should also be noted that using only one approach may not be sufficient to analyze malware. Using both approaches together will lead you to victory!

![process monitor tool](https://letsdefend.io/blog/wp-content/uploads/2022/05/static-analysis-vs-dynamic-analysis.png)

As a result, we cannot say that one approach is better than another. Each has an advantage over each other in different conditions.

If you work as a Level 1-2 SOC analyst, you can usually take action by quickly obtaining the address c2 with the help of dynamic analysis.

---

### Dynamic Analysis Example Using AnyRun

You can take advantage of sandbox services / products to quickly analyze malware.

[AnyRun](https://any.run/) is an interactive sandbox that you can use when you want to analyze malware quickly.

AnyRun has options for paid or free use. If you want to take advantage of it for free, all your analysis is visible to others, therefore we do not recommend that you upload files that may contain personal data to AnyRun. In addition, the free plan has restrictions such as usage time.

How can we use AnyRun for our malware analysis, what kind of outputs we can get, let's examine it together.

Let's download the malware with hash **80b51e872031a2befeb9a0a13e6fc480** to analyze via [AbuseCH (Click here to download)](https://bazaar.abuse.ch/sample/708e198608b5b463224c3fb77fcf708b845d0c7b5dbc6e9cab9e185c489be089/).

We have to click on the "**+**" **(New Task)** button on the left menu to upload the malware we downloaded.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-22.48.58.png)

Let's upload the file we want to analyze on the screen that opens with the help of the "Choose a file" button. After the file is uploaded, we can determine the parameters such as which operating system we want to run the malware and 32/64 bit of operating system to use. After determining these, we open our sandbox with the help of the "**Run**" button at the bottom right of the screen that opens.

When our machine is turned on, we run the malicious software we uploaded to see it's activities.

Some malware stays dormant for a certain period of time before performing its malicious activities, making analysis difficult. Let's allow time for the malware to perform its activities, during this time, let's examine the AnyRun interface together.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-22.58.53-scaled.jpg)

1. From this area, you can use the operating system interactively.
2. Here is a list of processes in this section. From here, you can easily see which childprocesses the malware you run has.
3. In this area there is network and files events.
4. This section contains details of the process.

Let's examine these outputs.

First, let's examine the process events of the malware in the section marked "2" in the image above.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.11.38.png)

The malware we run manually seems to have created 2 child processes. One of them is **schtasks.exe**, which is run to ensure persistence on the system by creating a schedule task and the other is the process specified as "**AgentTesla**" malware by AnyRun.

When we click on Processes, information about this process is displayed in panel number 4. Let's examine the details of all processes respectively.

Since the process named "WinRAR.exe" is created when we extract the malware from the archive file to run it, we will not examine this process.

When we click on the process with ID **2680**, information about this process is listed on panel number **4**.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.17.33.png)

With the "**More Info**" button on this panel, a page with detailed information about the process is opened. When we want to reach detailed information, we can use this section.

When the process information with 2680 ID is examined, the malware:

- Uses Task Scheduler,
- Writes a program to the file system which compile time is too old,
- Writes many files to the user directory

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.25.05.png)

When we examine the process with ID **2616**, we see that it is **schtasks.exe** belonging to **Task Scheduler**.

When we examine the "**Command Line**" parameters, we see that it creates a schedule task named "**Updates\neHneiobyhcrJJ**". The configurations for this schedule task are in the file "**tmp5383.tmp**".

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.29.26.png)

When we examine the schedule task configuration file named **tmp5383.tmp**, we see that the program named "**neHneiobyhcrJJ.exe**" will run.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.32.53.png)

When we examine the process with ID **3140**:

- This malware is recognized by AnyRun as **AgentTesla**,
- Steals credentials,
- Creating files in the user directory

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.36.06.png)

When we examine the network connections made from panel number 3, we see that malware connects to **smtp.godforeu.com**.

With the help of the button on the right of the panel, we can examine the incoming/outgoing data.

![](https://letsdefend.io/blog/wp-content/uploads/2021/01/Screen-Shot-2021-01-26-at-23.39.10.png)

When the network activities of the malware are examined, we find that malware exfiltrates data with the SMTP protocol.

If you want to examine, you can reach the analysis made [here (Click here)](https://app.any.run/tasks/e4979ab7-3145-4121-a042-ea91d7e2c86b).
### Questions Progress

(Access AnyRun report to answer this question) What is the email address that the malware connects to the mail server to steal data?

(Access AnyRun report to answer this question) What is the password malware use while connecting to the mail server?

---

### 29 Addresses to Analyze Malware Faster

We constantly spend time analyzing malware. We have listed 29 addresses that can be useful for **blue team** members to use time more effectively:

- [Anlyz](https://sandbox.anlyz.io/)
- [Any.run](https://app.any.run/)
- [Comodo Valkyrie](https://valkyrie.comodo.com/)
- [Cuckoo](https://sandbox.pikker.ee/)
- [Hybrid Analysis](http://www.hybrid-analysis.com/)
- [Intezer Analyze](https://www.intezer.com/)
- [SecondWrite Malware Deepview](https://www.secondwrite.com/)
- [Jevereg](http://jevereg.amnpardaz.com/)
- [IObit Cloud](http://cloud.iobit.com/)
- [BinaryGuard](http://www.binaryguard.com/)
- [BitBlaze](http://bitblaze.cs.berkeley.edu/)
- [SandDroid](http://sanddroid.xjtu.edu.cn/)
- [Joe Sandbox](https://www.joesandbox.com/#windows)
- [AMAaaS](https://amaaas.com/)
- [IRIS-H](https://iris-h.services/pages/dashboard#/pages/dashboard)
- [Gatewatcher Intelligence](https://intelligence.gatewatcher.com/)
- [Hatching Triage](https://tria.ge/) 
- [InQuest Labs](https://labs.inquest.net/dfi)
- [Manalyzer](https://manalyzer.org/)
- [SandBlast Analysis](https://threatpoint.checkpoint.com/ThreatPortal/emulation)
- [SNDBOX](https://app.sndbox.com/)
- [firmware](http://firmware.re/)
- [opswat](https://metadefender.opswat.com/?lang=en)
- [virusade](http://virusade.com/)
- [virustotal](https://www.virustotal.com/gui/)
- [malware config](https://malwareconfig.com/)
- [malware hunter team](https://id-ransomware.malwarehunterteam.com/)
- [virscan](http://www.virscan.org/) 
- [jotti](https://virusscan.jotti.org/it)

---


